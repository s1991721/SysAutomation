#1.安装 cloudflared
sudo apt install cloudflared

#2.自动生成域名并推送 GitHub
sudo nano /usr/local/bin/cloudflare_tunnel.sh

```
#!/bin/bash

LOGFILE="/home/jef/cloudflare-url-repo/cloudflared.log"
URLFILE="/home/jef/cloudflare-url-repo/tunnel_url.txt"

# cloudflared 的绝对路径（按你的实际路径改）
CLOUDFLARED_CMD=("/usr/local/bin/cloudflared" "tunnel" "--url" "http://localhost:80")

# 清掉旧日志
: > "$LOGFILE"

# 启动 cloudflared 到后台
"${CLOUDFLARED_CMD[@]}" >> "$LOGFILE" 2>&1 &
CF_PID=$!

# 等一会儿，让它输出 URL
sleep 5
TUNNEL_URL=""

for i in {1..10}; do
    TUNNEL_URL=$(grep -o "https://[a-zA-Z0-9.-]*\.trycloudflare\.com" "$LOGFILE" | head -n 1)
    if [[ -n "$TUNNEL_URL" ]]; then
        break
    fi
    sleep 2
done

if [[ -n "$TUNNEL_URL" ]]; then
    echo "$TUNNEL_URL" > "$URLFILE"

    cd /home/jef/cloudflare-url-repo || exit 1
    echo "$TUNNEL_URL" > current_url.txt
    git add current_url.txt
    git commit -m "Update tunnel url" || true
    git push || true
fi

# 关键：不要让脚本直接退出，等待 cloudflared 进程
wait "$CF_PID"

```

#3.给予执行权限
sudo chown jef:jef /usr/local/bin/cloudflare_tunnel.sh
sudo chmod +x /usr/local/bin/cloudflare_tunnel.sh
sudo chown -R jef:jef /home/jef/cloudflare-url-repo


#4.配置 systemd 开机自启
sudo nano /etc/systemd/system/cloudflare-tunnel.service

```
[Unit]
Description=Cloudflare tunnel with auto GitHub upload
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=jef
Group=jef
WorkingDirectory=/home/jef/cloudflare-url-repo
ExecStart=/usr/local/bin/cloudflare_tunnel.sh
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
```

#4.1 刷新 systemd
sudo systemctl daemon-reload

#4.2 设置开机启动
sudo systemctl enable cloudflare-tunnel

#4.3 立即启动
sudo systemctl start cloudflare-tunnel

#4.4 检查服务状态
systemctl status cloudflare-tunnel


